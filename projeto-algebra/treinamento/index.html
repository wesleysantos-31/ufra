<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBRAS AI Trainer - TensorFlow.js + MediaPipe</title>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- TensorFlow.js e KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>

    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --accent-color: #00e676;
            --text-color: #ffffff;
            --secondary-text: #b0b0b0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout em duas colunas */
        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        .sidebar {
            width: 350px;
            background-color: var(--panel-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-left: 1px solid #333;
            overflow-y: auto;
        }

        /* Vídeo e Canvas */
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1280px;
            max-height: 720px;
        }

        .input_video { display: none; }
        
        .output_canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1); /* Espelhar */
        }

        /* Overlay de Previsão */
        .prediction-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            text-align: center;
            z-index: 10;
        }

        .prediction-text {
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
        }

        .confidence-bar {
            height: 4px;
            background: #333;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.2s;
        }

        /* Controles da Sidebar */
        h2 { margin: 0; font-size: 1.2rem; color: var(--accent-color); }
        p { font-size: 0.9rem; color: var(--secondary-text); margin: 5px 0 15px; }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #2c2c2c;
            color: white;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-add { background: var(--accent-color); color: #000; }
        .btn-add:hover { background: #00c853; }
        
        .btn-train {
            background: #333; 
            color: white; 
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .btn-train:active { background: var(--accent-color); color: #000; }
        
        .class-list {
            flex: 1;
            overflow-y: auto;
            border-top: 1px solid #333;
            padding-top: 10px;
        }

        .badge {
            background: #555;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .instructions-box {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #ccc;
            border-left: 3px solid var(--accent-color);
        }

        /* Loader */
        .loading {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--accent-color);
            font-size: 1.5rem;
        }
    </style>
</head>
<body>

    <div class="loading" id="loader">Carregando IA e Câmera...</div>

    <div class="main-content">
        <div class="video-container">
            <video class="input_video"></video>
            <canvas class="output_canvas"></canvas>
            
            <div class="prediction-overlay">
                <p class="prediction-text" id="result-text">?</p>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidence-meter"></div>
                </div>
                <div style="font-size: 0.8rem; color: #ccc; margin-top:5px;">Confiança: <span id="conf-val">0</span>%</div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div>
            <h2>Treinamento LIBRAS</h2>
            <p>Adicione classes e treine seu modelo.</p>
        </div>

        <div class="instructions-box">
            <strong>Como usar:</strong>
            1. Digite o nome da letra (ex: "A").<br>
            2. Clique em "Adicionar Classe".<br>
            3. Faça o sinal com a mão.<br>
            4. <strong>Segure o clique</strong> no botão da lista para coletar exemplos (tente variar levemente o ângulo).
        </div>

        <div class="input-group">
            <input type="text" id="class-name" placeholder="Nome (Ex: Letra A)">
            <button class="btn-add" onclick="addClass()">Adicionar</button>
        </div>

        <div class="class-list" id="class-list">
            <!-- Botões de classes aparecerão aqui -->
        </div>

        <div style="margin-top: auto;">
            <button onclick="saveModel()" style="width: 100%; background: #444; color: white; margin-bottom: 5px;">Salvar Modelo (Download JSON)</button>
            <button onclick="document.getElementById('file-input').click()" style="width: 100%; background: #444; color: white;">Carregar Modelo</button>
            <input type="file" id="file-input" style="display: none;" onchange="loadModel(this)">
        </div>
    </div>

    <script>
        // --- Variáveis Globais ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const loader = document.getElementById('loader');
        
        // Elementos de UI
        const resultText = document.getElementById('result-text');
        const confMeter = document.getElementById('confidence-meter');
        const confVal = document.getElementById('conf-val');
        const classListDiv = document.getElementById('class-list');

        // Estado da IA
        let classifier;
        let isTraining = false;
        let currentClassLabel = null;
        let classes = {}; // Armazena nomes e contagem de exemplos
        let lastLandmarks = null; // Armazena o último frame de landmarks detectado

        // --- Inicialização do TensorFlow KNN ---
        async function initAI() {
            classifier = knnClassifier.create();
            console.log("KNN Classifier carregado");
        }

        // --- Funções de UI ---

        function addClass() {
            const nameInput = document.getElementById('class-name');
            const name = nameInput.value.trim().toUpperCase();
            
            if (!name) return alert("Digite um nome para a letra!");
            if (classes[name]) return alert("Essa classe já existe!");

            classes[name] = 0; // 0 exemplos iniciais
            nameInput.value = "";
            renderClassList();
        }

        function renderClassList() {
            classListDiv.innerHTML = "";
            Object.keys(classes).forEach(className => {
                const btn = document.createElement('button');
                btn.className = 'btn-train';
                btn.innerHTML = `<span>${className}</span> <span class="badge">${classes[className]} ex.</span>`;
                
                // Eventos para treinar ao segurar o botão
                btn.onmousedown = () => startTraining(className);
                btn.onmouseup = () => stopTraining();
                btn.onmouseleave = () => stopTraining();
                
                // Touch events para mobile
                btn.ontouchstart = (e) => { e.preventDefault(); startTraining(className); };
                btn.ontouchend = () => stopTraining();

                classListDiv.appendChild(btn);
            });
        }

        function startTraining(className) {
            if(!lastLandmarks) {
                alert("Nenhuma mão detectada! Coloque a mão na frente da câmera.");
                return;
            }
            isTraining = true;
            currentClassLabel = className;
        }

        function stopTraining() {
            isTraining = false;
            currentClassLabel = null;
        }

        // --- Lógica Principal (Loop) ---

        function onResults(results) {
            // Ajustar tamanho do canvas
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                lastLandmarks = landmarks;

                // Desenhar esqueleto
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00e676', lineWidth: 4});
                drawLandmarks(canvasCtx, landmarks, {color: '#ff0000', lineWidth: 1});

                // Converter landmarks para Tensor (Input da IA)
                // Pegamos x, y, z de cada um dos 21 pontos
                const embedding = landmarks.map(l => [l.x, l.y, l.z]).flat();
                const tensor = tf.tensor(embedding);

                // Se estiver treinando (segurando botão)
                if (isTraining && currentClassLabel) {
                    classifier.addExample(tensor, currentClassLabel);
                    classes[currentClassLabel]++;
                    // Atualiza UI de forma otimizada (throttle simples)
                    if(classes[currentClassLabel] % 5 === 0) renderClassList();
                }

                // Se tivermos classes treinadas, fazer previsão
                if (classifier.getNumClasses() > 0 && !isTraining) {
                    predict(tensor);
                } else if (!isTraining && classifier.getNumClasses() === 0) {
                    resultText.innerText = "Treine";
                    resultText.style.fontSize = "1.5rem";
                }

                // Limpeza de memória do tensor é importante no loop
                // Mas o classifier precisa dele para addExample, então descartamos depois
                // No KNN predictClass o tensor é consumido.
                // Como passamos para func, o JS lida, mas em app grande usaríamos tf.tidy()
                tensor.dispose();

            } else {
                lastLandmarks = null;
                resultText.innerText = "?";
                confMeter.style.width = "0%";
            }
            canvasCtx.restore();
        }

        async function predict(tensor) {
            try {
                const result = await classifier.predictClass(tensor);
                
                if (result.label) {
                    resultText.innerText = result.label;
                    resultText.style.fontSize = "3rem";
                    
                    const confidence = Math.floor(result.confidences[result.label] * 100);
                    confVal.innerText = confidence;
                    confMeter.style.width = `${confidence}%`;

                    // Muda cor se confiança for baixa
                    if(confidence < 70) {
                        resultText.style.color = "yellow";
                    } else {
                        resultText.style.color = "var(--accent-color)";
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Setup MediaPipe ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7, // Mais rigoroso para evitar ruído
            minTrackingConfidence: 0.7
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        // Inicializar tudo
        initAI().then(() => {
            camera.start();
            loader.style.display = 'none';
        });


        // --- Funções Extras: Salvar/Carregar Modelo (JSON) ---
        // Como o KNN salva o dataset inteiro, isso pode ficar grande, mas funciona para demos.
        
        function saveModel() {
            if(classifier.getNumClasses() === 0) return alert("Nada para salvar!");
            
            const dataset = classifier.getClassifierDataset();
            let datasetObj = {};
            
            Object.keys(dataset).forEach((key) => {
                let data = dataset[key].dataSync();
                datasetObj[key] = Array.from(data);
            });
            
            const jsonStr = JSON.stringify({ dataset: datasetObj, classes: classes });
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = "libras_model.json";
            a.click();
        }

        function loadModel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Restaurar metadados
                    classes = json.classes;
                    renderClassList();

                    // Restaurar tensores do KNN
                    const dataset = json.dataset;
                    const tensorObj = {};
                    
                    Object.keys(dataset).forEach((key) => {
                        tensorObj[key] = tf.tensor(dataset[key], [dataset[key].length / 63, 63]);
                    });
                    
                    classifier.setClassifierDataset(tensorObj);
                    alert("Modelo carregado com sucesso!");
                    
                } catch(err) {
                    console.error(err);
                    alert("Erro ao carregar modelo. Arquivo inválido?");
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>