<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de M√£o</title>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- TensorFlow.js e KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>

    <style>
        :root {
            --primary: #00ff88;
            --bg: #121212;
            --surface: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* Container do V√≠deo */
        .viewport {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        .input_video { display: none; }
        
        .output_canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Mant√©m propor√ß√£o sem esticar */
            transform: scaleX(-1); /* Espelhar */
        }

        /* Interface Sobreposta */
        .hud {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 10;
            pointer-events: none; /* Deixa clicar no v√≠deo se necess√°rio */
        }

        .result-box {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--primary);
            padding: 15px 40px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
            transition: all 0.3s ease;
        }

        .result-letter {
            font-size: 5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0;
            line-height: 1;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .result-conf {
            font-size: 1rem;
            color: #ccc;
            margin-top: 5px;
        }

        /* Barra de Controles Inferior */
        .controls {
            position: absolute;
            bottom: 30px;
            background: rgba(30, 30, 30, 0.9);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            pointer-events: auto;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .btn-upload {
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #555;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-upload:hover {
            background: #444;
            border-color: white;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4444;
        }

        .status-text {
            font-size: 0.9rem;
            color: #aaa;
        }

        .loading-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #121212;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <div class="loading-screen" id="loader">Inicializando Sistema...</div>

    <div class="viewport">
        <video class="input_video"></video>
        <canvas class="output_canvas"></canvas>

        <div class="hud">
            <div class="result-box" id="display-box" style="opacity: 0.5;">
                <p class="result-letter" id="main-text">-</p>
                <div class="result-conf" id="conf-text">Aguardando Modelo...</div>
            </div>
        </div>

        <div class="controls">
            <div class="status-dot" id="status-dot"></div>
            <span class="status-text" id="status-msg">Modelo n√£o carregado</span>
            
            <label class="btn-upload">
                üìÇ Importar JSON
                <input type="file" id="model-upload" accept=".json" style="display: none;" onchange="loadModel(this)">
            </label>
        </div>
    </div>

    <script>
        // --- Elementos DOM ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const mainText = document.getElementById('main-text');
        const confText = document.getElementById('conf-text');
        const displayBox = document.getElementById('display-box');
        const statusDot = document.getElementById('status-dot');
        const statusMsg = document.getElementById('status-msg');
        const loader = document.getElementById('loader');

        // --- Estado do Sistema ---
        let classifier;
        let isModelLoaded = false;

        // --- Inicializa√ß√£o ---
        async function init() {
            // Inicializa KNN
            classifier = knnClassifier.create();
            
            // Configura C√¢mera e MediaPipe
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });

            hands.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });

            await camera.start();
            loader.style.display = 'none';
        }

        // --- Loop Principal (Frame a Frame) ---
        function onResults(results) {
            // Ajustar Canvas
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Desenhar Imagem da C√¢mera
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                // Desenhar Esqueleto
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00ff88', lineWidth: 4});
                drawLandmarks(canvasCtx, landmarks, {color: '#ffffff', lineWidth: 1, radius: 3});

                // Se o modelo estiver carregado, prever
                if (isModelLoaded) {
                    predictLetter(landmarks);
                }
            } else {
                // Se n√£o detectar m√£o
                if (isModelLoaded) {
                    mainText.innerText = "...";
                    confText.innerText = "Posicione a m√£o";
                }
            }
            canvasCtx.restore();
        }

        // --- Fun√ß√£o de Previs√£o ---
        async function predictLetter(landmarks) {
            // Converte landmarks para Tensor
            const embedding = landmarks.map(l => [l.x, l.y, l.z]).flat();
            const tensor = tf.tensor(embedding);

            try {
                const result = await classifier.predictClass(tensor);
                
                if (result.label) {
                    mainText.innerText = result.label;
                    const confidence = Math.floor(result.confidences[result.label] * 100);
                    confText.innerText = `Certeza: ${confidence}%`;

                    // Feedback visual baseado na confian√ßa
                    if (confidence > 80) {
                        displayBox.style.borderColor = "#00ff88";
                        displayBox.style.boxShadow = "0 0 30px rgba(0, 255, 136, 0.4)";
                        mainText.style.color = "#00ff88";
                    } else {
                        displayBox.style.borderColor = "#ffff00";
                        displayBox.style.boxShadow = "none";
                        mainText.style.color = "#ffff00";
                    }
                }
            } catch (error) {
                console.error("Erro na previs√£o:", error);
            } finally {
                tensor.dispose(); // Limpa mem√≥ria
            }
        }

        // --- Carregar Modelo JSON ---
        function loadModel(input) {
            const file = input.files[0];
            if (!file) return;

            statusMsg.innerText = "Carregando...";
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Verifica se o JSON tem a estrutura esperada do nosso treinador
                    if (!json.dataset) {
                        throw new Error("Formato de JSON inv√°lido");
                    }

                    // Reconstr√≥i os tensores para o KNN
                    const dataset = json.dataset;
                    const tensorObj = {};
                    
                    Object.keys(dataset).forEach((key) => {
                        // Divide por 63 porque s√£o 21 pontos * 3 coordenadas (x,y,z)
                        tensorObj[key] = tf.tensor(dataset[key], [dataset[key].length / 63, 63]);
                    });
                    
                    classifier.setClassifierDataset(tensorObj);
                    
                    // Atualiza Interface
                    isModelLoaded = true;
                    statusDot.style.backgroundColor = "#00ff88";
                    statusDot.style.boxShadow = "0 0 10px #00ff88";
                    statusMsg.innerText = "Modelo Ativo: " + file.name;
                    displayBox.style.opacity = "1";
                    mainText.innerText = "OK";
                    confText.innerText = "Fa√ßa um sinal";
                    
                    console.log("Modelo carregado com sucesso.");

                } catch(err) {
                    console.error(err);
                    alert("Erro ao ler o arquivo. Certifique-se que √© o JSON gerado pelo treinador.");
                    statusMsg.innerText = "Erro no arquivo";
                    statusDot.style.backgroundColor = "red";
                }
            };
            reader.readAsText(file);
        }

        // Inicia o app
        init();

    </script>
</body>
</html>